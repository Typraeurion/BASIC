85 IF C9<2 THEN PRINT "YOU MUST HAVE AT LEAST TWO COLORS, OR IT WON'T BE MUCH OF A CONTEST!":GOTO 80
105 IF P9<1 THEN PRINT "ONLY POSITIVE NUMBERS, PLEASE!":GOTO 100
110 IF P9>25 THEN PRINT "BE REASONABLE!":GOTO 100
135 IF P>9.0E+15 THEN PRINT "THAT'S BEYOND MY CAPACITY.  TRY FEWER COLORS OR POSITIONS.":GOTO 80
142 MAXMOVES=INT(P9+P9*LOG(C9)/1.38629436112+0.99999994)
143 IF 3*MAXMOVES<2*C9 THEN MAXMOVES=INT(C9*2/3+0.75)
144 BALTRIALS=INT(P9*LOG(C9)*1.442695041)
145 IF BALTRIALS>=MAXMOVES THEN BALTRIALS=MAXMOVES-1
146 PRINT "PLAYERS HAVE A MAXIMUM OF";MAXMOVES;"GUESSES PER TURN."
148 INPUT "NUMBER OF ROUNDS";R9
150 DIM Q(P9),S(MAXMOVES,2),S$(MAXMOVES),A$(P9),G$(P9),H$(P9)
155 DIM GHIST$(MAXMOVES,P9),BHIST(MAXMOVES),WHIST(MAXMOVES)
330
340 X=A
360
370 FOR M=1 TO MAXMOVES
620 PRINT "YOU RAN OUT OF MOVES!  THAT'S ALL YOU GET!"
627 PRINT :GOTO 640
690
700
710 BALLEFT=BALTRIALS:MODE=0
740 FOR M=1 TO MAXMOVES
745 IF MODE THEN XCAND=INT(P*RND(1)+1):GOTO 770
750 GOSUB 7500:REM BALANCED GUESS
755 BALLEFT=BALLEFT-1:IF BALLEFT<=0 THEN MODE=1
760 GOSUB 7800:XCAND=X:REM SET X TO THE GUESS IN Q()
770 IF M=1 THEN XLAST=0:GOTO 790
780 K=M-1:GOSUB 7000:XLAST=X:REM GET OUR MOST RECENT GUESS
790 FOR XADD=0 TO P-1
795 X=XADD+XCAND:IF X>P THEN X=X-P
800 REM     DON'T REPEAT OUR LAST GUESS
805 IF X=XLAST THEN NEXT XADD:GOTO 850
810 GOSUB 3500:REM COMPUTE Q() FROM X
820 FOR K=1 TO M-1
822 GOSUB 4000:REM MAP Q() -> A$()
824 GOSUB 7000:REM COPY GHIST$(K,1-P9) TO G$(1-P9)
826 GOSUB 4500:REM COMPARE A$() WITH G$()
830 IF B<>BHIST(K) OR W<>WHIST(K) THEN NEXT XADD:GOTO 850
835 NEXT K
840 GOTO 930:REM FITS ALL PRIOR KNOWLEDGE; ACCEPT THIS CANDIDATE
880
890
900
910
920
1000 GOSUB 7200:REM COPY H$() TO GHIST$(M,)
1010 BHIST(M)=B1
1020 WHIST(M)=W1
1030
1035
1040
1050
1060
1070
3510 REM     COMPUTE Q(1-P9) FROM X, CONVERTING IT TO BASE C9
3520 REM     AND PUTTING THE LEAST SIGNIFICANT DIGIT IN Q(1) AND SO ON.
3522
3524
3526
3527
3528
3529
3530 REM
3540 N=X-1
3550 FOR S=1 TO P9
3560 Q(S)=(N-INT(N/C9)*C9)+1
3570 N=INT(N/C9)
3580 NEXT S
3590 RETURN
7000 REM
7010 REM     COPY GHIST$(K,1-P9) TO G$(1-P9).
7020 REM     THE CALLER MUST SET K TO AN ENTRY FROM 1-(CURRENT MOVE -1)
7030 REM
7040 FOR S=1 TO P9
7050 G$(S)=GHIST$(K,S)
7060 NEXT S
7070 RETURN
7200 REM
7210 REM     COPY H$(1-P9) TO GHIST$(M,1-P9),
7220 REM     WHERE M IS THE COMPUTER'S CURRENT MOVE
7230 REM
7240 FOR S=1 TO P9
7250 GHIST$(M,S)=H$(S)
7260 NEXT S
7270 RETURN
7500 REM
7510 REM     FISHER-YATES SELECTION OF A RANDOM "BALANCED" GUESS;
7520 REM     PROVIDED COURTESY OF CHATGPT (SOFTWARE ARCHITECT)
7530 REM
7540 REM     STEP 1: SELECT A MIXTURE OF "COLORS", STARTING AT A RANDOM ONE.
7550 C1=INT(C9*RND(1)+1):S=C1
7560 FOR J=1 TO P9
7570 Q(J)=C1
7580 C1=C1+1:IF C1>C9 THEN C1=1
7590 NEXT J
7600 REM     STEP 2: SHUFFLE Q()
7610 FOR J=P9 TO 2 STEP -1
7620 T=INT(J*RND(1)+1):IF T=J THEN 7640
7630 TEMP=Q(J):Q(J)=Q(T):Q(T)=TEMP
7640 NEXT J
7650 RETURN
7800 REM
7810 REM     CONVERT Q(1-P9) TO X (REVERSE OPERATION FROM 3500)
7820 REM
7830 X=0
7840 FOR S=1 TO P9
7850 X=X+Q(S)*C9^(S-1)
7860 NEXT S
7870 RETURN
8010 DATA "BLACK","WHITE","RED","GREEN","ORANGE","YELLOW","PURPLE","TAN"
10000 REM
10010 REM     REVISED COMPUTER GUESSING ALGORITHM
10020 REM
10030 REM     THIS PROCEEDS IN THREE PHASES, DEMARKED BY SOME NUMBER OF
10040 REM     BALANCED GUESSES AND THE POINT AT WHICH WE KNOW THE COMPLETE
10050 REM     SET OF COLORS (B+W=P9) BUT NOT THE ORDER (B<P9).
10060 REM
10070 REM     IN THE FIRST PHASE, FIND THE PRIOR GUESS WHICH RESULTED
10080 REM     IN THE HIGHEST B+W TOTAL (IF THERE IS ONE).  CHOOSE B+W
10090 REM     COLORS AT RANDOM FROM THAT SET (NONE ON THE FIRST GUESS)
10100 REM     PLUS P9-(B+W) COLORS *NOT* FROM THE REMAINING COLORS IN
10110 REM     THAT SET (FROM ALL COLORS ON THE FIRST GUESS) SUCH THAT
10120 REM     THE NUMBERS OF THE LATTER ARE AS EVEN AS POSSIBLE.  LEAVE
10130 REM     (B) COLORS FROM THE FIRST SET IN THEIR ORIGINAL POSITION
10140 REM     AND SHUFFLE THE REMAINING COLORS.  CHECK AGAINST ANY PRIOR
10150 REM     GUESSES; IF IT DOESN'T WORK, STORE IT AS INVALID AND
10160 REM     TRY AGAIN IF THE BALANCE TRY COUNT IS LESS THAN THE LIMIT
10170 REM     OTHERWISE MOVE ON TO THE SECOND PHASE.  IF IT PASSES ALL
10180 REM     PRIOR TESTS, PRESENT IT AS THE NEXT GUESS.  IF WE HAVEN'T
10190 REM     WON YET, STORE THE GUESS IN OUR HISTORY AS WELL AS THE
10200 REM     INVALID COMBINATIONS LIST ALONG WITH THE SCORE OF BLACK
10210 REM     AND WHITE PEGS AND CONTINUE WITH THE NEXT MOVE.
10220 REM
10230 REM     THE SECOND PHASE IS A BRUTE-FORCE APPROACH.  IF B+W=P9
10240 REM     THEN SKIP THIS PHASE AND MOVE ON TO PHASE THREE.  OTHERWISE
10250 REM     SORT THE LIST OF INVALID COMBINATIONS FROM PHASE ONE.
10260 REM     CHOOSE A COMBINATION AT RANDOM FROM THIS LIST AND, STARTING
10270 REM     FROM THE NEXT COMBINATION IN SEQUENCE UNTIL THE NEXT
10280 REM     INVALID COMBINATION IN THE LIST, TRY EACH ONE AGAINST ALL
10290 REM     PRIOR GUESSES.  IF WE FIND ONE WHICH FITS PRESENT THAT AS
10300 REM     THE NEXT GUESS, AND IF WE HAVEN'T WON YET SET THAT GUESS
10310 REM     AS THE NEW END OF THE CURRENT RANGE (AS WELL AS ADDING IT
10320 REM     TO THE GUESS / SCORE HISTORY) AND CONTINUE WITH THE NEXT
10330 REM     MOVE.  IF WE REACH THE NEXT RANGE OF INVALID COMBINATIONS,
10340 REM     MERGE THE RANGES TOGETHER AND CONTINUE CHECKING WITH THE
10350 REM     NEXT COMBINATION FOLLOWING THE NEW RANGE.  IF WE REACH
10360 REM     THE END OF THE SPACE OF ALL POSSIBLE COMBINATIONS, WRAP
10370 REM     AROUND TO THE FIRST COMBINATION.  IF ALL RANGES HAVE BEEN
10380 REM     MERGED DECLARE AN ERROR.
10390 REM
10400 REM     THE THIRD PHASE SWITCHES TO LOOKING OVER A PERMUTATION OF
10410 REM     P9 POSITIONS (P9! PERMUTATIONS WITH POSSIBLE DUPLICATES)
10420 REM     RATHER THAN C9^P9 COMBINATIONS.  RESET THE LIST OF INVALID
10430 REM     COMBINATIONS WITH THE GUESS THAT RESULTED IN B+W=P9.  SELECT
10440 REM     (B) COLORS FROM THE LAST GUESS AT RANDOM TO LEAVE IN PLACE
10450 REM     AND SHUFFLE THE REMAINING COLORS.  CHECK IT AGAINST THE
10460 REM     PREVIOUS GUESSES; IF IT DOESN'T WORK, ADD IT TO THE LIST
10470 REM     OF INVALID GUESSES AND REPEAT UNTIL THE LIST IS FULL.
10480 REM     WHEN THE LIST GETS FULL, MOVE TO PHASE FOUR.
10490 REM
10500 REM     THE FOURTH PHASE IS THE NEXT BRUTE-FORCE APPROACH.
10510 REM     SORT THE LIST OF INVALID COMBINATIONS FROM PHASE THREE.
10520 REM     CHOOSE A PERMUTATION AT RANDOM FROM THIS LIST AND,
10530 REM     STARTING WITH THE NEXT PERMUTATION IN A LEXOGRAPHICAL ORDER
10540 REM     UNTIL THE NEXT INVALID COMBINATION IN THE LIST, TRY EACH
10550 REM     ONE AGAINST ALL PRIOR GUESSES.  IF WE FIND ONE WHICH FITS
10560 REM     PRESENT THAT AS THE NEXT GUESS, AND IF WE HAVEN'T WON YET
10570 REM     SET THAT GUESS AS THE NEW END OF THE CURRENT RANGE (AS IN
10580 REM     PHASE TWO) AND CONTINUE WITH THE NEXT MOVE.  IF WE REACH
10590 REM     THE NEXT RANGE OF INVALID PERMUTATIONS, MERGE THE RANGES
10600 REM     TOGETHER AND CONTINUE CHECKING WITH THE NEXT PERMUTATION
10610 REM     FOLLOWING THE NEW RANGE.  IF WE REACHTHE END OF THE SPACE
10620 REM     OF ALL POSSIBLE PERMUTATIONS (I.E. ALL COLORS IN REVERSE
10630 REM     ORDER), WRAP AROUND TO THE FIRST PERMUTATION (I.E. ALL
10640 REM     COLORS IN ORDER).  IF ALL RANGES HAVE BEEN MERGED DECLARE
10650 REM     AN ERROR.
